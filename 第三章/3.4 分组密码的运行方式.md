### 分组密码的运行模式（ECB、CBC、CFB、OFB）

在分组密码（如 DES 或 AES）中，输入数据通常以固定长度的**分组**进行加密。然而，许多实际应用中，输入的数据长度并不一定是分组大小的整数倍。因此，如何处理数据的不同长度、如何将多个加密的分组连接起来，是一个重要的课题。

在3.2节讲述的是如何用DES对一个分组进行加密。分组密码的运行模式，是将数据分组之后，如何将数据送入加密，减少一些规律。

---

### 1. **电子密码本模式（ECB）**

#### **通俗解释：**

**ECB（Electronic Codebook）** 是最简单的分组密码模式。每个输入的分组都被独立加密，输出对应的密文分组。这就像一个自动的加密“字典”，每个相同的输入都会得到相同的密文。

- **优点**：实现简单，易于并行处理。
    
- **缺点**：如果两个相同的明文分组被加密，它们会产生相同的密文，这样就可能泄露数据的结构信息。例如，某些特定的重复模式（如文件中反复出现的固定字符串）可能会暴露出来。
    

#### **严格定义：**

在 ECB 模式中，明文被分成固定长度的块，分别用相同的密钥加密，得到密文块。设明文分块为 $P_1, P_2, \dots, P_n$ ，加密操作为 $E_k$ ，则：

$$C_i = E_k(P_i)$$

其中，$C_i$  是加密后的密文块，$E_k$  是加密函数，$P_i$  是明文分块，$k$ 是加密密钥。

- **缺点**：如前所述，相同的输入分组生成相同的密文，因此在没有进一步保护的情况下，ECB 是不安全的。
    

#### **举例：**

假设我们使用 **AES** 加密算法，明文是 128 位数据“ABABABABABABABAB”（每8个字符一个分组），如果采用 ECB 模式加密，每个分组都会被独立加密，结果是“ABABABABABABABAB”会在密文中重复出现，**暴露了明文的结构**。


![](../Attachment_box/Pasted%20image%2020250716111330.png)


---

### 2. **密码分组链接模式（CBC）**

#### **通俗解释：**

**CBC（Cipher Block Chaining）** 是一种链式加密模式，它将每个明文分组与前一个加密后的密文分组进行异或操作，再加密后得到新的密文。这样即使相同的明文分组出现在不同的位置，由于前一个密文的影响，密文也会完全不同。

- **优点**：比 ECB 更安全，因为它解决了相同明文产生相同密文的问题。
    
- **缺点**：加密过程不能并行处理，且需要额外的初始化向量（IV）来开始链式加密。
    

#### **严格定义：**

设明文分为 $P_1, P_2, \dots, P_n$  和对应的密文 $C_1, C_2, \dots, C_n$ ，初始化向量为 $IV$ ，加密操作为 $E_k$ ，则 CBC 模式的加密过程为：

$$C_1 = E_k(P_1 \oplus IV)$$$$C_i = E_k(P_i \oplus C_{i-1}), \quad \text{for} \quad i = 2, 3, \dots, n$$


解密过程为：

$$P_1 = D_k(C_1) \oplus IV $$$$P_i = D_k(C_i) \oplus C_{i-1}, \quad \text{for} \quad i = 2, 3, \dots, n$$

#### **举例：**

假设我们用 AES 加密明文“Hello Hello Hello”并使用 CBC 模式，假设第一个分组是“Hello”，并且给定一个随机的初始化向量 $IV$ ，加密后第一个密文块将是  $C_1 = E_k(P_1 \oplus IV)$ ，第二个密文块则是 $C_2 = E_k(P_2 \oplus C_1)$ ，以此类推。


![](../Attachment_box/Pasted%20image%2020250716111504.png)


![](../Attachment_box/Pasted%20image%2020250716111528.png)


---

### 3. **密码反馈模式（CFB）**

#### **通俗解释：**

**CFB（Cipher Feedback）** 是一种反馈模式，它将加密后的密文的一部分反馈作为下一个分组的加密输入。CFB 通过反馈机制减少了明文对密文的直接依赖，因此增强了加密的安全性。

- **优点**：能够处理任意长度的输入数据（不仅仅是分组大小的整数倍）。
    
- **缺点**：比 ECB 和 CBC 更复杂，且解密过程与加密过程相同，因此需要相同的操作。
    

#### **严格定义：**

CFB 模式分为多种类型，如 **CFB-1**、**CFB-8** 等，下面以 **CFB-1** 为例。在 CFB-1 中，加密过程如下：

- 密钥流由密文的反馈构造出来。
    
- 设 $C_1, C_2, \dots, C_n$  为密文块，初始向量 $IV$ ，加密操作 $E_k$ ：
$$S_1 = E_k(IV)$$$$C_1 = P_1 \oplus S_1$$ $$S_2 = E_k(C_1)，由C_{i-1}得来$$$$C_2 = P_2 \oplus S_2, \quad \dots$$

#### **举例：**

如果采用 **AES** 作为加密算法，并且使用 **CFB-1** 模式，首先将 **IV** 输入加密器生成密钥流 $S_1$ ，然后将明文的第一个比特与密钥流进行异或，得到密文。接着用密文的第一个比特来更新反馈，继续加密下一个比特，直到完成。


![](../Attachment_box/Pasted%20image%2020250716113924.png)

![](../Attachment_box/Pasted%20image%2020250716113935.png)


---

### 4. **输出反馈模式（OFB）**

#### **通俗解释：**

**OFB（Output Feedback）** 是一种输出反馈模式，它通过连续加密初始化向量 $IV$ ，生成密钥流，然后将密钥流与明文进行异或操作得到密文。与 CFB 模式不同，OFB 只对输出进行反馈，而不涉及密文。

- **优点**：允许在加密之前先进行密文的准备，因此也支持任意长度的数据，并且比 CFB 稍微更高效。
    
- **缺点**：如果密钥流重复（比如 IV 重复），会严重降低安全性。
    

#### **严格定义：**

OFB 模式的加密过程如下：

1. $S_1 = E_k(IV)$ 
    
2. $C_1 = P_1 \oplus S_1$ 
    
3. $S_2 = E_k(S_1)$ ，由 $S_{i-1} 得来$ 
    
4. $C_2 = P_2 \oplus S_2$ 
    
5. 重复此过程直到加密所有明文。
    

#### **举例：**

如果采用 **AES** 算法，且使用 **OFB** 模式，第一个加密操作是用 IV 加密得到 $S_1$ ，然后将明文的第一个分组与 $S_1$ 异或得到密文 $C_1$ 。接下来，不是将 $C_1$  反馈给加密器，而是将 $S_1$  继续加密生成 $S_2$，然后继续操作。


![](../Attachment_box/Pasted%20image%2020250716114413.png)

![](../Attachment_box/Pasted%20image%2020250716114442.png)


---

### 总结

|模式|主要特点|优点|缺点|
|---|---|---|---|
|**ECB**|每个分组独立加密|简单易实现，支持并行加密|相同的明文块加密结果相同，容易泄露信息|
|**CBC**|前一个密文影响当前密文的加密|防止相同明文块加密结果相同|不能并行加密，需要初始化向量（IV）|
|**CFB**|使用密文的一部分作为反馈输入|支持任意长度输入，解密过程与加密相同|比较复杂，反馈延迟会影响效率|
|**OFB**|用加密后的反馈作为输入生成密钥流|支持任意长度输入，解密过程与加密相同|反馈不当可能降低安全性，依赖IV|
